{"version":3,"file":"IpLogger-C5hIdHiL.js","sources":["../../src/lib/supabaseClient.js","../../src/components/IpLogger.jsx"],"sourcesContent":["import { createClient } from '@supabase/supabase-js';\n\nconst supabaseUrl = import.meta.env.VITE_SUPABASE_URL;\nconst supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY;\n\nexport const supabase = createClient(supabaseUrl, supabaseAnonKey);\n","import React, { useEffect } from 'react';\nimport { supabase } from '../lib/supabaseClient';\nimport { v4 as uuidv4 } from 'uuid';\n\n/**\n * Utility: exponential back‑off retry\n * @param {Function} fn - async function to retry\n * @param {number} retries - number of attempts\n * @param {number} delay - initial delay in ms\n */\nasync function retry(fn, retries = 3, delay = 500) {\n  try {\n    return await fn();\n  } catch (err) {\n    if (retries <= 0) throw err;\n    await new Promise((res) => setTimeout(res, delay));\n    return retry(fn, retries - 1, delay * 2);\n  }\n}\n\nexport default function IpLogger() {\n  useEffect(() => {\n    const controller = new AbortController();\n    const signal = controller.signal;\n    let isMounted = true; // guard against state updates after unmount\n\n    const logVisitor = async () => {\n      // Prevent duplicate logs in the same session\n      if (localStorage.getItem('visitorLogged')) return;\n\n      try {\n        // 1️⃣ Validate IP API URL\n        const ipApiUrl = import.meta.env.VITE_IP_API_URL;\n        if (!ipApiUrl) throw new Error('IP API URL not configured');\n        // 2️⃣ Fetch IP data with retry\n        const ipResponse = await retry(\n          () => fetch(ipApiUrl, { signal }),\n          3,\n          500\n        );\n        if (!ipResponse.ok)\n          throw new Error(`IP API error: ${ipResponse.status}`);\n\n        const ipData = await ipResponse.json();\n        if (!ipData?.ip) throw new Error('IP data missing');\n\n        // Optional: fill missing fields with 'Unknown'\n        const visitorData = {\n          unique_id: uuidv4(),\n          ip: ipData.ip,\n          city: ipData.city || 'Unknown',\n          region: ipData.region || 'Unknown',\n          country: ipData.country_name || 'Unknown',\n          user_agent: navigator.userAgent,\n          timestamp: new Date().toISOString(),\n        };\n\n        // 3️⃣ Insert into Supabase\n        const { error } = await supabase.from('Producer').insert([visitorData]);\n        if (error) throw error;\n\n        if (isMounted) {\n          console.log('Visitor data stored successfully:', visitorData);\n          localStorage.setItem('visitorLogged', 'true');\n        }\n      } catch (err) {\n        // Better logging for debugging\n        if (err.name === 'AbortError') return; // ignore fetch abort\n        console.error('Visitor data logging failed:', err.message || err);\n      }\n    };\n\n    logVisitor();\n\n    // Cleanup on unmount\n    return () => {\n      isMounted = false;\n      controller.abort();\n    };\n  }, []);\n\n  return null;\n}\n"],"names":["supabaseUrl","supabaseAnonKey","supabase","createClient","retry","fn","retries","delay","err","res","IpLogger","useEffect","controller","signal","isMounted","ipApiUrl","ipResponse","ipData","visitorData","uuidv4","error"],"mappings":"wIAEA,MAAMA,EAAc,2CACdC,EAAkB,mNAEXC,EAAWC,EAAaH,EAAaC,CAAe,ECKjE,eAAeG,EAAMC,EAAIC,EAAU,EAAGC,EAAQ,IAAK,CACjD,GAAI,CACF,OAAO,MAAMF,EAAA,CACf,OAASG,EAAK,CACZ,GAAIF,GAAW,EAAG,MAAME,EACxB,aAAM,IAAI,QAASC,GAAQ,WAAWA,EAAKF,CAAK,CAAC,EAC1CH,EAAMC,EAAIC,EAAU,EAAGC,EAAQ,CAAC,CACzC,CACF,CAEA,SAAwBG,GAAW,CACjCC,OAAAA,EAAAA,UAAU,IAAM,CACd,MAAMC,EAAa,IAAI,gBACjBC,EAASD,EAAW,OAC1B,IAAIE,EAAY,GA8ChB,OA5CmB,SAAY,CAE7B,GAAI,cAAa,QAAQ,eAAe,EAExC,GAAI,CAEF,MAAMC,EAAW,wBAGXC,EAAa,MAAMZ,EACvB,IAAM,MAAMW,EAAU,CAAE,OAAAF,EAAQ,EAChC,EACA,GAAA,EAEF,GAAI,CAACG,EAAW,GACd,MAAM,IAAI,MAAM,iBAAiBA,EAAW,MAAM,EAAE,EAEtD,MAAMC,EAAS,MAAMD,EAAW,KAAA,EAChC,GAAI,CAACC,GAAQ,GAAI,MAAM,IAAI,MAAM,iBAAiB,EAGlD,MAAMC,EAAc,CAClB,UAAWC,EAAA,EACX,GAAIF,EAAO,GACX,KAAMA,EAAO,MAAQ,UACrB,OAAQA,EAAO,QAAU,UACzB,QAASA,EAAO,cAAgB,UAChC,WAAY,UAAU,UACtB,UAAW,IAAI,KAAA,EAAO,YAAA,CAAY,EAI9B,CAAE,MAAAG,GAAU,MAAMlB,EAAS,KAAK,UAAU,EAAE,OAAO,CAACgB,CAAW,CAAC,EACtE,GAAIE,EAAO,MAAMA,EAEbN,GACF,4CAC4C,OAC9CN,EAAA,MACO,OAAK,aAAA,OAEZ,QAAQ,qCAAuBA,EAAA,SAAAA,CAAA,CAC/B,CAAgE,GAEpE,EAEA,IAAW,CAGXM,EAAa,GACXF,EAAA,MAAY,CACZ,CAAiB,EACnB,CAAA,CAAA,EACG,IAEL"}