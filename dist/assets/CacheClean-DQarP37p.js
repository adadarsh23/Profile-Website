import{r as p,j as u}from"./vendor_react-CPmtnjo4.js";import"./vendor-BExhudyu.js";const h={IDLE:"idle",INITIALIZING:"initializing",RUNNING:"running",SUCCESS:"success",ERROR:"error",CANCELLED:"cancelled"},r={ERROR:"error",WARN:"warn",INFO:"info",DEBUG:"debug"},X={autoReload:!1,silent:!0,preserveKeys:["auth","token","user","theme","session"],runDelay:1e3,debug:!1,manual:!1,ttlHours:24,progressUI:!1,statusIndicator:!0,retries:3,retryDelayMS:500,taskTimeoutMS:2e4,enableHealthCheck:!0,enableAnalytics:!1,gracefulDegradation:!0};class ee{constructor(t=!1,e=!1){this.silent=t,this.debug=e,this.logs=[],this.maxLogs=1e3}log(t,e=r.INFO,s={}){const o={timestamp:new Date().toISOString(),level:e,message:t,meta:s};this.logs.push(o),this.logs.length>this.maxLogs&&this.logs.shift(),!(this.silent&&e!==r.ERROR)&&e===r.DEBUG&&this.debug}getLogs(){return[...this.logs]}exportLogs(){return JSON.stringify(this.logs,null,2)}}class te{constructor(t=3,e=500){this.maxRetries=t,this.baseDelay=e}async execute(t,e="Task"){let s;for(let o=0;o<=this.maxRetries;o++)try{return await t()}catch(a){if(s=a,o<this.maxRetries){const i=this.baseDelay*Math.pow(2,o);await this.sleep(i)}}throw new Error("".concat(e," failed after ").concat(this.maxRetries+1," attempts: ").concat(s.message))}sleep(t){return new Promise(e=>setTimeout(e,t))}}class I{static race(t,e,s="Task"){return Promise.race([t,new Promise((o,a)=>setTimeout(()=>a(new Error("".concat(s," timeout after ").concat(e,"ms"))),e))])}}class re{constructor(t,e=[]){this.logger=t,this.preserveKeys=e}shouldPreserve(t){return this.preserveKeys.some(e=>t.toLowerCase().includes(e.toLowerCase()))}clearWebStorage(t,e){try{const s=Object.keys(t),o=[],a=[];return s.forEach(i=>{if(this.shouldPreserve(i))o.push(i);else try{t.removeItem(i),a.push(i)}catch(g){this.logger.log("Failed to remove ".concat(e," key: ").concat(i),r.WARN,{error:g.message})}}),this.logger.log("".concat(e,": removed ").concat(a.length,", preserved ").concat(o.length),r.INFO),{success:!0,removed:a.length,preserved:o.length,keys:{removed:a,preserved:o}}}catch(s){return this.logger.log("".concat(e," cleanup failed"),r.ERROR,{error:s.message}),{success:!1,error:s.message}}}clearCookies(){try{const t=document.cookie.split(";").filter(Boolean);let e=0,s=0;return t.forEach(o=>{const a=o.split("=")[0].trim();if(this.shouldPreserve(a))s++;else try{document.cookie="".concat(a,"=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;"),document.cookie="".concat(a,"=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;domain=").concat(window.location.hostname),e++}catch(i){this.logger.log("Failed to delete cookie: ".concat(a),r.WARN)}}),this.logger.log("Cookies: deleted ".concat(e,", preserved ").concat(s),r.INFO),{success:!0,deleted:e,preserved:s}}catch(t){return this.logger.log("Cookie cleanup failed",r.ERROR,{error:t.message}),{success:!1,error:t.message}}}async clearCacheStorage(t,e){try{if(!("caches"in window))return this.logger.log("CacheStorage API not supported",r.WARN),{success:!0,deleted:0,skipped:!0};const s=await I.race(caches.keys(),e,"CacheStorage.keys()"),o=s.filter(f=>!this.shouldPreserve(f)),a=s.length-o.length,i=await Promise.allSettled(o.map(f=>t.execute(()=>I.race(caches.delete(f),e,"Delete cache: ".concat(f)),"CacheStorage.delete(".concat(f,")")))),g=i.filter(f=>f.status==="fulfilled").length,c=i.filter(f=>f.status==="rejected").length;return this.logger.log("CacheStorage: deleted ".concat(g,", preserved ").concat(a,", failed ").concat(c),r.INFO),{success:!0,deleted:g,preserved:a,failed:c}}catch(s){return this.logger.log("CacheStorage cleanup failed",r.ERROR,{error:s.message}),{success:!1,error:s.message}}}async clearIndexedDB(t){try{if(!("indexedDB"in window))return this.logger.log("IndexedDB API not supported",r.WARN),{success:!0,deleted:0,skipped:!0};let e=[];if(typeof indexedDB.databases=="function")try{e=await I.race(indexedDB.databases(),t,"IndexedDB.databases()")||[]}catch(c){return this.logger.log("IndexedDB.databases() not available, skipping",r.WARN),{success:!0,deleted:0,skipped:!0}}else return this.logger.log("IndexedDB.databases() not supported in this browser",r.WARN),{success:!0,deleted:0,skipped:!0};const s=e.filter(c=>c.name&&!this.shouldPreserve(c.name)),o=e.length-s.length,a=await Promise.allSettled(s.map(c=>new Promise((f,$)=>{const w=indexedDB.deleteDatabase(c.name);w.onsuccess=()=>f(c.name),w.onerror=()=>$(new Error("Failed to delete ".concat(c.name))),w.onblocked=()=>this.logger.log("IndexedDB delete blocked: ".concat(c.name),r.WARN)}))),i=a.filter(c=>c.status==="fulfilled").length,g=a.filter(c=>c.status==="rejected").length;return this.logger.log("IndexedDB: deleted ".concat(i,", preserved ").concat(o,", failed ").concat(g),r.INFO),{success:!0,deleted:i,preserved:o,failed:g}}catch(e){return this.logger.log("IndexedDB cleanup failed",r.ERROR,{error:e.message}),{success:!1,error:e.message}}}async unregisterServiceWorkers(t,e){try{if(!("serviceWorker"in navigator))return this.logger.log("Service Workers not supported",r.WARN),{success:!0,unregistered:0,skipped:!0};const s=await I.race(navigator.serviceWorker.getRegistrations(),e,"ServiceWorker.getRegistrations()"),o=await Promise.allSettled(s.map(g=>t.execute(()=>I.race(g.unregister(),e,"SW.unregister()"),"ServiceWorker.unregister()"))),a=o.filter(g=>g.status==="fulfilled").length,i=o.filter(g=>g.status==="rejected").length;return this.logger.log("Service Workers: unregistered ".concat(a,", failed ").concat(i),r.INFO),{success:!0,unregistered:a,failed:i}}catch(s){return this.logger.log("Service Worker cleanup failed",r.ERROR,{error:s.message}),{success:!1,error:s.message}}}}function se(S){const t=p.useMemo(()=>({...X,...S}),[S]),{autoReload:e,silent:s,preserveKeys:o,runDelay:a,debug:i,manual:g,ttlHours:c,progressUI:f,statusIndicator:$,retries:w,retryDelayMS:P,taskTimeoutMS:C,enableHealthCheck:U,enableAnalytics:M,gracefulDegradation:H,onComplete:k,onError:N,onProgress:E}=t,[x,D]=p.useState(h.IDLE),[L,Y]=p.useState(0),[q,V]=p.useState(!0),[A,O]=p.useState(!1),[oe,Z]=p.useState(null),W=p.useRef(!1),T=p.useRef(null),j=p.useRef(null),_=p.useRef(!1);T.current||(T.current=new ee(s,i));const d=T.current,b=p.useCallback(l=>{Y(R=>{const n=Math.min(100,Math.max(0,R+l));return E==null||E(n),n})},[E]),F=p.useCallback(()=>{const l={timestamp:new Date().toISOString(),browserAPIs:{localStorage:"localStorage"in window,sessionStorage:"sessionStorage"in window,indexedDB:"indexedDB"in window,cacheStorage:"caches"in window,serviceWorker:"serviceWorker"in navigator,cookies:!!document.cookie},lastCleanup:localStorage.getItem("__cleanup_last_run__"),status:"healthy"};return Z(l),d.log("Health check completed",r.INFO,l),l},[d]),B=p.useCallback(async(l=!1)=>{var G,z,J;if(W.current){d.log("Cleanup already in progress",r.WARN);return}if(!l){const m=Number(localStorage.getItem("__cleanup_last_run__")||0),y=(Date.now()-m)/(1e3*60*60);if(y<c){d.log("Cleanup not needed (".concat(y.toFixed(1),"h < ").concat(c,"h)"),r.INFO);return}}W.current=!0,_.current=!1,D(h.INITIALIZING),b(5);const R=performance.now(),n={startedAt:new Date().toISOString(),forced:l,config:{ttlHours:c,preserveKeys:o,retries:w,taskTimeoutMS:C},results:{}};try{d.log("Starting cleanup process",r.INFO),D(h.RUNNING),b(10);const m=new re(d,o),y=new te(w,P);if(_.current)throw new Error("Cleanup cancelled by user");const Q=[m.clearCacheStorage(y,C),m.clearIndexedDB(C),m.unregisterServiceWorkers(y,C)],v=await Promise.allSettled(Q);if(n.results.cacheStorage=v[0].value||{error:(G=v[0].reason)==null?void 0:G.message},n.results.indexedDB=v[1].value||{error:(z=v[1].reason)==null?void 0:z.message},n.results.serviceWorkers=v[2].value||{error:(J=v[2].reason)==null?void 0:J.message},b(50),_.current)throw new Error("Cleanup cancelled by user");n.results.localStorage=m.clearWebStorage(localStorage,"LocalStorage"),b(20),n.results.sessionStorage=m.clearWebStorage(sessionStorage,"SessionStorage"),b(15),n.results.cookies=m.clearCookies(),b(5);const K=Math.round(performance.now()-R);n.completedAt=new Date().toISOString(),n.durationMS=K,n.status="success",localStorage.setItem("__cleanup_last_run__",Date.now().toString()),localStorage.setItem("__cleanup_last_report__",JSON.stringify(n)),d.log("Cleanup completed in ".concat(K,"ms"),r.INFO,n),D(h.SUCCESS),b(100),k==null||k(n),M&&window.dispatchEvent(new CustomEvent("cache-cleanup-complete",{detail:n})),e&&(d.log("Auto-reload in 2 seconds",r.INFO),setTimeout(()=>window.location.reload(),2e3)),setTimeout(()=>V(!1),15e3)}catch(m){const y=Math.round(performance.now()-R);if(n.completedAt=new Date().toISOString(),n.durationMS=y,n.status="error",n.error=m.message,d.log("Cleanup failed: ".concat(m.message),r.ERROR,n),D(h.ERROR),N==null||N(m,n),localStorage.setItem("__cleanup_last_error__",JSON.stringify(n)),!H)throw m}finally{W.current=!1}},[d,c,o,w,P,C,b,e,M,H,k,N]);return p.useEffect(()=>{if(!(typeof window>"u")&&(d.log("CacheCleaner initialized",r.INFO,t),window.cacheCleaner={trigger:()=>B(!0),cancel:()=>{_.current=!0,d.log("Cleanup cancellation requested",r.WARN)},getHealth:F,getLogs:()=>d.getLogs(),exportLogs:()=>d.exportLogs(),getLastReport:()=>JSON.parse(localStorage.getItem("__cleanup_last_report__")||"null")},U&&F(),!g)){const l=setTimeout(()=>B(!1),a);return()=>clearTimeout(l)}},[t,B,d,g,a,F,U]),p.useEffect(()=>{if(!A)return;const l=setTimeout(()=>O(!1),1e4),R=n=>{j.current&&!j.current.contains(n.target)&&O(!1)};return document.addEventListener("mousedown",R),()=>{clearTimeout(l),document.removeEventListener("mousedown",R)}},[A]),q?u.jsxs(u.Fragment,{children:[f&&x===h.RUNNING&&u.jsx("div",{role:"progressbar","aria-valuenow":L,"aria-valuemin":0,"aria-valuemax":100,"aria-label":"Cache cleanup progress",style:{position:"fixed",top:0,left:0,width:"100%",height:"4px",zIndex:10001,backgroundColor:"rgba(59, 130, 246, 0.15)",backdropFilter:"blur(4px)"},children:u.jsx("div",{style:{width:"".concat(L,"%"),height:"100%",background:"linear-gradient(90deg, #3b82f6, #2563eb)",transition:"width 0.3s cubic-bezier(0.4, 0, 0.2, 1)",borderRadius:"0 4px 4px 0",boxShadow:"0 0 10px rgba(59, 130, 246, 0.5)"}})}),$&&u.jsxs("button",{onClick:()=>i&&O(l=>!l),"aria-label":"Cache cleaner status: ".concat(x),style:{position:"fixed",bottom:"20px",left:"20px",display:"flex",alignItems:"center",gap:"10px",padding:"8px 14px",borderRadius:"20px",backgroundColor:"rgba(0, 0, 0, 0.7)",backdropFilter:"blur(10px)",border:"1px solid rgba(255, 255, 255, 0.1)",cursor:i?"pointer":"default",zIndex:9999,transition:"all 0.3s ease",userSelect:"none"},onMouseEnter:l=>{i&&(l.currentTarget.style.transform="translateY(-2px)")},onMouseLeave:l=>{l.currentTarget.style.transform="translateY(0)"},children:[u.jsx("div",{style:{width:"12px",height:"12px",borderRadius:"50%",backgroundColor:x===h.RUNNING?"#3b82f6":x===h.SUCCESS?"#22c55e":x===h.ERROR?"#ef4444":"#6b7280",boxShadow:"0 0 8px ".concat(x===h.RUNNING?"#3b82f6":x===h.SUCCESS?"#22c55e":x===h.ERROR?"#ef4444":"transparent"),animation:x===h.RUNNING?"pulse 2s infinite":"none"}}),u.jsx("span",{style:{color:"#fff",fontSize:"13px",fontWeight:600,letterSpacing:"0.3px"},children:x===h.RUNNING?"Cleaning ".concat(L,"%"):x===h.SUCCESS?"✓ Clean":x===h.ERROR?"✗ Error":"Ready"})]}),i&&A&&u.jsxs("div",{ref:j,role:"dialog","aria-label":"Debug logs",style:{position:"fixed",bottom:"70px",left:"20px",width:"400px",maxHeight:"50vh",backgroundColor:"#1a1a1a",border:"1px solid #333",borderRadius:"12px",boxShadow:"0 8px 32px rgba(0, 0, 0, 0.5)",zIndex:1e4,overflow:"hidden",fontFamily:"monospace"},children:[u.jsxs("div",{style:{padding:"12px 16px",borderBottom:"1px solid #333",display:"flex",justifyContent:"space-between",alignItems:"center",backgroundColor:"#0a0a0a"},children:[u.jsx("span",{style:{color:"#fff",fontSize:"14px",fontWeight:600},children:"Debug Logs"}),u.jsx("button",{onClick:()=>O(!1),style:{background:"none",border:"none",color:"#888",cursor:"pointer",fontSize:"18px"},"aria-label":"Close debug panel",children:"×"})]}),u.jsx("div",{style:{padding:"12px",overflowY:"auto",maxHeight:"calc(50vh - 50px)",fontSize:"12px",lineHeight:1.6},children:d.getLogs().length===0?u.jsx("div",{style:{color:"#666",textAlign:"center",padding:"20px"},children:"No logs yet"}):d.getLogs().map((l,R)=>u.jsxs("div",{style:{marginBottom:"8px",paddingBottom:"8px",borderBottom:"1px solid #222"},children:[u.jsx("div",{style:{color:"#666",fontSize:"10px"},children:new Date(l.timestamp).toLocaleTimeString()}),u.jsx("div",{style:{color:l.level===r.ERROR?"#ef4444":l.level===r.WARN?"#f59e0b":l.level===r.INFO?"#3b82f6":"#8b5cf6"},children:l.message})]},R))})]}),u.jsx("style",{children:"\n          @keyframes pulse {\n            0%, 100% { opacity: 1; }\n            50% { opacity: 0.5; }\n          }\n        "})]}):null}function le(){return u.jsx("div",{children:u.jsx(se,{autoReload:!1,silent:!1,debug:!0,progressUI:!0,statusIndicator:!0,ttlHours:12,manual:!1,preserveKeys:["auth","token","user","theme","session"],retries:3,taskTimeoutMS:2e4,enableHealthCheck:!0,enableAnalytics:!1,gracefulDegradation:!0,onComplete:S=>{},onError:(S,t)=>{console.error("❌ Cleanup failed:",S)},onProgress:S=>{}})})}export{le as default};
