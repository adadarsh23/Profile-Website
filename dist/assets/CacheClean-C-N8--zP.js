import{r as p,j as c}from"./vendor_react-Da-vahsZ.js";import"./vendor-D9UvdN1x.js";const h={IDLE:"idle",INITIALIZING:"initializing",RUNNING:"running",SUCCESS:"success",ERROR:"error",CANCELLED:"cancelled"},r={ERROR:"error",WARN:"warn",INFO:"info",DEBUG:"debug"},ee={autoReload:!1,silent:!0,preserveKeys:["auth","token","user","theme","session"],runDelay:1e3,debug:!1,manual:!1,ttlHours:24,progressUI:!1,statusIndicator:!0,retries:3,retryDelayMS:500,taskTimeoutMS:2e4,enableHealthCheck:!0,enableAnalytics:!1,gracefulDegradation:!0};class te{constructor(t=!1,e=!1){this.silent=t,this.debug=e,this.logs=[],this.maxLogs=1e3}log(t,e=r.INFO,s={}){const a={timestamp:new Date().toISOString(),level:e,message:t,meta:s};this.logs.push(a),this.logs.length>this.maxLogs&&this.logs.shift(),!(this.silent&&e!==r.ERROR)&&e===r.DEBUG&&this.debug}getLogs(){return[...this.logs]}exportLogs(){return JSON.stringify(this.logs,null,2)}}class re{constructor(t=3,e=500){this.maxRetries=t,this.baseDelay=e}async execute(t,e="Task"){let s;for(let a=0;a<=this.maxRetries;a++)try{return await t()}catch(o){if(s=o,a<this.maxRetries){const i=this.baseDelay*Math.pow(2,a);await this.sleep(i)}}throw new Error("".concat(e," failed after ").concat(this.maxRetries+1," attempts: ").concat(s.message))}sleep(t){return new Promise(e=>setTimeout(e,t))}}class I{static race(t,e,s="Task"){return Promise.race([t,new Promise((a,o)=>setTimeout(()=>o(new Error("".concat(s," timeout after ").concat(e,"ms"))),e))])}}class se{constructor(t,e=[]){this.logger=t,this.preserveKeys=e}shouldPreserve(t){return this.preserveKeys.some(e=>t.toLowerCase().includes(e.toLowerCase()))}clearWebStorage(t,e){try{const s=Object.keys(t),a=[],o=[];return s.forEach(i=>{if(this.shouldPreserve(i))a.push(i);else try{t.removeItem(i),o.push(i)}catch(g){this.logger.log("Failed to remove ".concat(e," key: ").concat(i),r.WARN,{error:g.message})}}),this.logger.log("".concat(e,": removed ").concat(o.length,", preserved ").concat(a.length),r.INFO),{success:!0,removed:o.length,preserved:a.length,keys:{removed:o,preserved:a}}}catch(s){return this.logger.log("".concat(e," cleanup failed"),r.ERROR,{error:s.message}),{success:!1,error:s.message}}}clearCookies(){try{const t=document.cookie.split(";").filter(Boolean);let e=0,s=0;return t.forEach(a=>{const o=a.split("=")[0].trim();if(this.shouldPreserve(o))s++;else try{document.cookie="".concat(o,"=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;"),document.cookie="".concat(o,"=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;domain=").concat(window.location.hostname),e++}catch(i){this.logger.log("Failed to delete cookie: ".concat(o),r.WARN)}}),this.logger.log("Cookies: deleted ".concat(e,", preserved ").concat(s),r.INFO),{success:!0,deleted:e,preserved:s}}catch(t){return this.logger.log("Cookie cleanup failed",r.ERROR,{error:t.message}),{success:!1,error:t.message}}}async clearCacheStorage(t,e){try{if(!("caches"in window))return this.logger.log("CacheStorage API not supported",r.WARN),{success:!0,deleted:0,skipped:!0};const s=await I.race(caches.keys(),e,"CacheStorage.keys()"),a=s.filter(f=>!this.shouldPreserve(f)),o=s.length-a.length,i=await Promise.allSettled(a.map(f=>t.execute(()=>I.race(caches.delete(f),e,"Delete cache: ".concat(f)),"CacheStorage.delete(".concat(f,")")))),g=i.filter(f=>f.status==="fulfilled").length,u=i.filter(f=>f.status==="rejected").length;return this.logger.log("CacheStorage: deleted ".concat(g,", preserved ").concat(o,", failed ").concat(u),r.INFO),{success:!0,deleted:g,preserved:o,failed:u}}catch(s){return this.logger.log("CacheStorage cleanup failed",r.ERROR,{error:s.message}),{success:!1,error:s.message}}}async clearIndexedDB(t){try{if(!("indexedDB"in window))return this.logger.log("IndexedDB API not supported",r.WARN),{success:!0,deleted:0,skipped:!0};let e=[];if(typeof indexedDB.databases=="function")try{e=await I.race(indexedDB.databases(),t,"IndexedDB.databases()")||[]}catch(u){return this.logger.log("IndexedDB.databases() not available, skipping",r.WARN),{success:!0,deleted:0,skipped:!0}}else return this.logger.log("IndexedDB.databases() not supported in this browser",r.WARN),{success:!0,deleted:0,skipped:!0};const s=e.filter(u=>u.name&&!this.shouldPreserve(u.name)),a=e.length-s.length,o=await Promise.allSettled(s.map(u=>new Promise((f,A)=>{const v=indexedDB.deleteDatabase(u.name);v.onsuccess=()=>f(u.name),v.onerror=()=>A(new Error("Failed to delete ".concat(u.name))),v.onblocked=()=>this.logger.log("IndexedDB delete blocked: ".concat(u.name),r.WARN)}))),i=o.filter(u=>u.status==="fulfilled").length,g=o.filter(u=>u.status==="rejected").length;return this.logger.log("IndexedDB: deleted ".concat(i,", preserved ").concat(a,", failed ").concat(g),r.INFO),{success:!0,deleted:i,preserved:a,failed:g}}catch(e){return this.logger.log("IndexedDB cleanup failed",r.ERROR,{error:e.message}),{success:!1,error:e.message}}}async unregisterServiceWorkers(t,e){try{if(!("serviceWorker"in navigator))return this.logger.log("Service Workers not supported",r.WARN),{success:!0,unregistered:0,skipped:!0};const s=await I.race(navigator.serviceWorker.getRegistrations(),e,"ServiceWorker.getRegistrations()"),a=await Promise.allSettled(s.map(g=>t.execute(()=>I.race(g.unregister(),e,"SW.unregister()"),"ServiceWorker.unregister()"))),o=a.filter(g=>g.status==="fulfilled").length,i=a.filter(g=>g.status==="rejected").length;return this.logger.log("Service Workers: unregistered ".concat(o,", failed ").concat(i),r.INFO),{success:!0,unregistered:o,failed:i}}catch(s){return this.logger.log("Service Worker cleanup failed",r.ERROR,{error:s.message}),{success:!1,error:s.message}}}}function ae(b){const t=p.useMemo(()=>({...ee,...b}),[b]),{autoReload:e,silent:s,preserveKeys:a,runDelay:o,debug:i,manual:g,ttlHours:u,progressUI:f,statusIndicator:A,retries:v,retryDelayMS:P,taskTimeoutMS:C,enableHealthCheck:U,enableAnalytics:M,gracefulDegradation:H,onComplete:N,onError:E,onProgress:D}=t,[x,O]=p.useState(h.IDLE),[L,Y]=p.useState(0),[V,Z]=p.useState(!0),[k,_]=p.useState(!1),[z,X]=p.useState(null),W=p.useRef(!1),j=p.useRef(null),B=p.useRef(null),$=p.useRef(!1);j.current||(j.current=new te(s,i));const d=j.current,w=p.useCallback(n=>{Y(S=>{const l=Math.min(100,Math.max(0,S+n));return D==null||D(l),l})},[D]),T=p.useCallback(()=>{const n={timestamp:new Date().toISOString(),browserAPIs:{localStorage:"localStorage"in window,sessionStorage:"sessionStorage"in window,indexedDB:"indexedDB"in window,cacheStorage:"caches"in window,serviceWorker:"serviceWorker"in navigator,cookies:!!document.cookie},lastCleanup:localStorage.getItem("__cleanup_last_run__"),status:"healthy"};return X(n),d.log("Health check completed",r.INFO,n),n},[d]),F=p.useCallback(async(n=!1)=>{var G,J,K;if(W.current){d.log("Cleanup already in progress",r.WARN);return}if(!n){const m=Number(localStorage.getItem("__cleanup_last_run__")||0),R=(Date.now()-m)/(1e3*60*60);if(R<u){d.log("Cleanup not needed (".concat(R.toFixed(1),"h < ").concat(u,"h)"),r.INFO);return}}W.current=!0,$.current=!1,O(h.INITIALIZING),w(5);const S=performance.now(),l={startedAt:new Date().toISOString(),forced:n,config:{ttlHours:u,preserveKeys:a,retries:v,taskTimeoutMS:C},results:{}};try{d.log("Starting cleanup process",r.INFO),O(h.RUNNING),w(10);const m=new se(d,a),R=new re(v,P);if($.current)throw new Error("Cleanup cancelled by user");const Q=[m.clearCacheStorage(R,C),m.clearIndexedDB(C),m.unregisterServiceWorkers(R,C)],y=await Promise.allSettled(Q);if(l.results.cacheStorage=y[0].value||{error:(G=y[0].reason)==null?void 0:G.message},l.results.indexedDB=y[1].value||{error:(J=y[1].reason)==null?void 0:J.message},l.results.serviceWorkers=y[2].value||{error:(K=y[2].reason)==null?void 0:K.message},w(50),$.current)throw new Error("Cleanup cancelled by user");l.results.localStorage=m.clearWebStorage(localStorage,"LocalStorage"),w(20),l.results.sessionStorage=m.clearWebStorage(sessionStorage,"SessionStorage"),w(15),l.results.cookies=m.clearCookies(),w(5);const q=Math.round(performance.now()-S);l.completedAt=new Date().toISOString(),l.durationMS=q,l.status="success",localStorage.setItem("__cleanup_last_run__",Date.now().toString()),localStorage.setItem("__cleanup_last_report__",JSON.stringify(l)),d.log("Cleanup completed in ".concat(q,"ms"),r.INFO,l),O(h.SUCCESS),w(100),N==null||N(l),M&&window.dispatchEvent(new CustomEvent("cache-cleanup-complete",{detail:l})),e&&(d.log("Auto-reload in 2 seconds",r.INFO),setTimeout(()=>window.location.reload(),2e3)),setTimeout(()=>Z(!1),15e3)}catch(m){const R=Math.round(performance.now()-S);if(l.completedAt=new Date().toISOString(),l.durationMS=R,l.status="error",l.error=m.message,d.log("Cleanup failed: ".concat(m.message),r.ERROR,l),O(h.ERROR),E==null||E(m,l),localStorage.setItem("__cleanup_last_error__",JSON.stringify(l)),!H)throw m}finally{W.current=!1}},[d,u,a,v,P,C,w,e,M,H,N,E]);return p.useEffect(()=>{if(!(typeof window>"u")&&(d.log("CacheCleaner initialized",r.INFO,t),window.cacheCleaner={trigger:()=>F(!0),cancel:()=>{$.current=!0,d.log("Cleanup cancellation requested",r.WARN)},getHealth:T,getLogs:()=>d.getLogs(),exportLogs:()=>d.exportLogs(),getLastReport:()=>JSON.parse(localStorage.getItem("__cleanup_last_report__")||"null")},U&&T(),!g)){const n=setTimeout(()=>F(!1),o);return()=>clearTimeout(n)}},[t,F,d,g,o,T,U]),p.useEffect(()=>{if(!k)return;const n=setTimeout(()=>_(!1),1e4),S=l=>{B.current&&!B.current.contains(l.target)&&_(!1)};return document.addEventListener("mousedown",S),()=>{clearTimeout(n),document.removeEventListener("mousedown",S)}},[k]),V?(p.useEffect(()=>(document.body.style.overflow=k?"hidden":"auto",()=>document.body.style.overflow="auto"),[k]),c.jsxs(c.Fragment,{children:[f&&x===h.RUNNING&&c.jsx("div",{role:"progressbar","aria-valuenow":L,"aria-valuemin":0,"aria-valuemax":100,"aria-label":"Cache cleanup progress",style:{position:"fixed",top:0,left:0,width:"100%",height:"4px",zIndex:10001,backgroundColor:"rgba(59, 130, 246, 0.15)",backdropFilter:"blur(4px)"},children:c.jsx("div",{style:{width:"".concat(L,"%"),height:"100%",background:"linear-gradient(90deg, #3b82f6, #2563eb)",transition:"width 0.3s cubic-bezier(0.4, 0, 0.2, 1)",borderRadius:"0 4px 4px 0",boxShadow:"0 0 10px rgba(59, 130, 246, 0.5)"}})}),A&&c.jsxs("button",{onClick:()=>i&&_(n=>!n),"aria-label":"Cache cleaner status: ".concat(x),style:{position:"fixed",bottom:"clamp(10px, 2vw, 20px)",left:"clamp(10px, 2vw, 20px)",display:"flex",alignItems:"center",gap:"clamp(6px, 1.5vw, 10px)",padding:"clamp(6px, 1.5vw, 8px) clamp(10px, 3vw, 14px)",borderRadius:"20px",backgroundColor:"rgba(0, 0, 0, 0.7)",backdropFilter:"blur(10px)",border:"1px solid rgba(255, 255, 255, 0.1)",cursor:i?"pointer":"default",zIndex:9999,transition:"all 0.3s ease",userSelect:"none"},onMouseEnter:n=>{i&&(n.currentTarget.style.transform="translateY(-2px)")},onMouseLeave:n=>{n.currentTarget.style.transform="translateY(0)"},children:[c.jsx("div",{style:{width:"clamp(10px, 2vw, 12px)",height:"clamp(10px, 2vw, 12px)",borderRadius:"50%",backgroundColor:x===h.RUNNING?"#3b82f6":x===h.SUCCESS?"#22c55e":x===h.ERROR?"#ef4444":"#6b7280",boxShadow:"0 0 8px ".concat(x===h.RUNNING?"#3b82f6":x===h.SUCCESS?"#22c55e":x===h.ERROR?"#ef4444":"transparent"),animation:x===h.RUNNING?"pulse 2s infinite":"none"}}),c.jsx("span",{style:{color:"#fff",fontSize:"clamp(11px, 2vw, 13px)",fontWeight:600,letterSpacing:"0.3px"},children:x===h.RUNNING?"Cleaning ".concat(L,"%"):x===h.SUCCESS?"✓ Clean":x===h.ERROR?"✗ Error":"Ready"})]}),i&&k&&c.jsxs("div",{ref:B,role:"dialog","aria-label":"Debug logs",style:{position:"fixed",bottom:"clamp(60px, 10vh, 80px)",left:"clamp(10px, 2vw, 20px)",width:"clamp(260px, 80vw, 400px)",maxHeight:"min(70vh, 400px)",backgroundColor:"#1a1a1a",border:"1px solid #333",borderRadius:"12px",boxShadow:"0 8px 32px rgba(0, 0, 0, 0.5)",zIndex:1e4,display:"flex",flexDirection:"column",fontFamily:"monospace",overflow:"hidden",pointerEvents:"auto"},children:[c.jsxs("div",{style:{padding:"12px 16px",borderBottom:"1px solid #333",display:"flex",justifyContent:"space-between",alignItems:"center",backgroundColor:"#0a0a0a",flexShrink:0},children:[c.jsx("span",{style:{color:"#fff",fontSize:"14px",fontWeight:600},children:"Debug Logs"}),c.jsx("button",{onClick:()=>_(!1),style:{background:"none",border:"none",color:"#888",cursor:"pointer",fontSize:"18px"},"aria-label":"Close debug panel",children:"×"})]}),c.jsxs("div",{style:{flex:1,overflowY:"auto",padding:"12px",fontSize:"clamp(10px, 2vw, 12px)",lineHeight:1.6,scrollbarWidth:"thin",scrollbarColor:"#444 #1a1a1a"},children:[z&&c.jsxs("div",{style:{marginBottom:"16px",paddingBottom:"16px",borderBottom:"1px solid #444"},children:[c.jsx("div",{style:{color:"#fff",fontSize:"13px",fontWeight:600,marginBottom:"8px"},children:"Health Status"}),c.jsx("pre",{style:{backgroundColor:"#2a2a2a",padding:"10px",borderRadius:"8px",overflowX:"auto",color:"#eee",fontSize:"clamp(9px, 1.8vw, 11px)",lineHeight:1.4,whiteSpace:"pre-wrap",wordBreak:"break-word"},children:JSON.stringify(z,null,2)})]}),d.getLogs().length===0?c.jsx("div",{style:{color:"#666",textAlign:"center",padding:"20px"},children:"No logs yet"}):d.getLogs().map((n,S)=>c.jsxs("div",{style:{marginBottom:"8px",paddingBottom:"8px",borderBottom:"1px solid #222"},children:[c.jsx("div",{style:{color:"#666",fontSize:"10px"},children:new Date(n.timestamp).toLocaleTimeString()}),c.jsx("div",{style:{color:n.level===r.ERROR?"#ef4444":n.level===r.WARN?"#f59e0b":n.level===r.INFO?"#3b82f6":"#8b5cf6"},children:n.message})]},S))]})]}),c.jsx("style",{children:'\n      @keyframes pulse {\n        0%, 100% { opacity: 1; }\n        50% { opacity: 0.5; }\n      }\n\n      @media (max-width: 480px) {\n        /* Status Indicator on very small screens */\n        button[aria-label^="Cache cleaner status"] {\n          bottom: 10px;\n          left: 10px;\n          padding: 8px; /* Make it a square button */\n          min-width: 40px; /* Ensure it\'s clickable */\n          justify-content: center;\n        }\n        button[aria-label^="Cache cleaner status"] span { /* Hide text */\n          display: none;\n        }\n        button[aria-label^="Cache cleaner status"] div { /* Adjust dot size */\n          width: 10px;\n          height: 10px;\n        }\n\n        /* Debug Panel on very small screens */\n        div[aria-label="Debug logs"] {\n          bottom: 60px;\n          left: 10px;\n          right: 10px; /* Make it span almost full width */\n          width: auto; /* Override clamp width */\n          max-height: 60vh; /* Allow more vertical space */\n        }\n        div[aria-label="Debug logs"] .debug-panel-header span {\n          font-size: 13px; /* Slightly smaller header font */\n        }\n      }\n    '})]})):null}function ne(){return c.jsx("div",{children:c.jsx(ae,{autoReload:!1,silent:!1,debug:!0,progressUI:!0,statusIndicator:!0,ttlHours:12,manual:!1,preserveKeys:["auth","token","user","theme","session"],retries:3,taskTimeoutMS:2e4,enableHealthCheck:!0,enableAnalytics:!1,gracefulDegradation:!0,onComplete:b=>{},onError:(b,t)=>{console.error("❌ Cleanup failed:",b)},onProgress:b=>{}})})}export{ne as default};
